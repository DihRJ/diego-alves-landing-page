<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Painel Administrativo - Diego Alves</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    background: #f7f7f7;
}
h2 {
    margin-top: 2rem;
    color: #333;
}
form {
    background: #fff;
    padding: 1rem 2rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
label {
    display: block;
    margin-top: 0.5rem;
    font-weight: bold;
}
input, textarea, select {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.25rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}
button {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background: #007cba;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
button:hover {
    background: #005a87;
}
button.danger {
    background: #dc3545;
}
button.danger:hover {
    background: #c82333;
}
#message {
    padding: 1rem;
    color: #fff;
    margin-bottom: 1rem;
    border-radius: 5px;
    display:none;
}
#message.success {
    background: #4CAF50;
}
#message.error {
    background: #f44336;
}
.pdf-list {
    background: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}
.pdf-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid #eee;
}
.pdf-item:last-child {
    border-bottom: none;
}
.pdf-info {
    flex-grow: 1;
}
.pdf-actions {
    display: flex;
    gap: 0.5rem;
}
.pdf-actions button {
    margin: 0;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
.portfolio-list {
    background: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}
.portfolio-item {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    margin-bottom: 1rem;
}
.portfolio-item:last-child {
    border-bottom: none;
}
.portfolio-title {
    font-weight: bold;
    color: #007cba;
}
.portfolio-url {
    color: #666;
    font-size: 0.9rem;
}
.portfolio-pdf {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}
</style>
</head>
<body>
<h1>Painel Administrativo - Diego Alves</h1>

<div id="message"></div>

<h2>Login do administrador</h2>
<form id="login-form">
    <label for="login-username">Usu√°rio:</label>
    <input type="text" id="login-username" name="username" required>
    <label for="login-password">Senha:</label>
    <input type="password" id="login-password" name="password" required>
    <button type="submit">Entrar</button>
</form>

<h2>Trocar Senha</h2>
<form id="change-password-form">
    <label for="old-password">Senha atual:</label>
    <input type="password" id="old-password" name="old_password" required>
    <label for="new-password">Nova senha:</label>
    <input type="password" id="new-password" name="new_password" required>
    <button type="submit">Alterar senha</button>
</form>

<h2>üìÑ Gerenciar PDFs</h2>

<h3>Upload de PDF</h3>
<form id="upload-pdf-form" enctype="multipart/form-data">
    <label for="pdf-file">Selecione o arquivo PDF (m√°x. 16MB):</label>
    <input type="file" id="pdf-file" name="pdf_file" accept="application/pdf" required>
    <button type="submit">Enviar PDF</button>
</form>

<h3>PDFs Dispon√≠veis</h3>
<div id="pdf-list" class="pdf-list">
    <p>Carregando PDFs...</p>
</div>

<h2>üîó Gerenciar Portf√≥lio</h2>

<h3>Adicionar novo link</h3>
<form id="add-portfolio-form">
    <label for="portfolio-title">T√≠tulo:</label>
    <input type="text" id="portfolio-title" name="title" required>
    <label for="portfolio-url">URL:</label>
    <input type="url" id="portfolio-url" name="url" required>
    <label for="portfolio-description">Descri√ß√£o (opcional):</label>
    <textarea id="portfolio-description" name="description" rows="3"></textarea>
    <label for="portfolio-pdf">PDF associado (opcional):</label>
    <select id="portfolio-pdf" name="pdf_url">
        <option value="">Nenhum PDF</option>
    </select>
    <button type="submit">Adicionar link</button>
</form>

<h3>Links do Portf√≥lio</h3>
<div id="portfolio-list" class="portfolio-list">
    <p>Carregando links...</p>
</div>

<script>
let availablePdfs = [];
let portfolioLinks = [];

function showMessage(text, type = 'success') {
    const msgDiv = document.getElementById('message');
    msgDiv.textContent = text;
    msgDiv.className = type === 'success' ? 'success' : 'error';
    msgDiv.style.display = 'block';
    setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
}

async function handleResponse(resp) {
    const data = await resp.json().catch(() => null);
    if (resp.ok) {
        if (data && data.message) {
            showMessage(data.message, 'success');
        } else {
            showMessage('Opera√ß√£o realizada com sucesso', 'success');
        }
        return data;
    } else {
        const err = data && (data.error || data.message) ? (data.error || data.message) : 'Erro ao processar solicita√ß√£o';
        showMessage(err, 'error');
        throw new Error(err);
    }
}

async function loadPdfs() {
    try {
        const resp = await fetch('/api/uploads/pdfs', {
            credentials: 'include'
        });
        availablePdfs = await resp.json();
        renderPdfList();
        updatePdfSelect();
    } catch (error) {
        document.getElementById('pdf-list').innerHTML = '<p>Erro ao carregar PDFs</p>';
    }
}

async function loadPortfolio() {
    try {
        const resp = await fetch('/api/portfolio/admin/links', {
            credentials: 'include'
        });
        portfolioLinks = await resp.json();
        renderPortfolioList();
    } catch (error) {
        document.getElementById('portfolio-list').innerHTML = '<p>Erro ao carregar links</p>';
    }
}

function renderPdfList() {
    const container = document.getElementById('pdf-list');
    if (availablePdfs.length === 0) {
        container.innerHTML = '<p>Nenhum PDF enviado ainda.</p>';
        return;
    }
    
    container.innerHTML = availablePdfs.map(pdf => `
        <div class="pdf-item">
            <div class="pdf-info">
                <strong>${pdf.filename}</strong><br>
                <small>Tamanho: ${(pdf.size / 1024).toFixed(1)} KB | Criado: ${new Date(pdf.created_at).toLocaleString('pt-BR')}</small>
            </div>
            <div class="pdf-actions">
                <button onclick="window.open('${pdf.url}', '_blank')">Ver</button>
                <button class="danger" onclick="deletePdf('${pdf.filename}')">Excluir</button>
            </div>
        </div>
    `).join('');
}

function renderPortfolioList() {
    const container = document.getElementById('portfolio-list');
    if (portfolioLinks.length === 0) {
        container.innerHTML = '<p>Nenhum link no portf√≥lio ainda.</p>';
        return;
    }
    
    container.innerHTML = portfolioLinks.map(link => `
        <div class="portfolio-item">
            <div class="portfolio-title">${link.title}</div>
            <div class="portfolio-url">${link.url}</div>
            <div>Status: ${link.is_active ? '‚úÖ Ativo' : '‚ùå Inativo'}</div>
            ${link.pdf_url ? `<div class="portfolio-pdf">üìÑ PDF: <a href="${link.pdf_url}" target="_blank">Ver PDF</a></div>` : ''}
            <div style="margin-top: 0.5rem;">
                <button onclick="editPortfolioLink(${link.id})">Editar</button>
                <button class="danger" onclick="deletePortfolioLink(${link.id})">Excluir</button>
                <button onclick="togglePortfolioLink(${link.id}, ${!link.is_active})">${link.is_active ? 'Desativar' : 'Ativar'}</button>
            </div>
        </div>
    `).join('');
}

function updatePdfSelect() {
    const select = document.getElementById('portfolio-pdf');
    select.innerHTML = '<option value="">Nenhum PDF</option>' + 
        availablePdfs.map(pdf => `<option value="${pdf.url}">${pdf.filename}</option>`).join('');
}

async function deletePdf(filename) {
    if (!confirm('Tem certeza que deseja excluir este PDF?')) return;
    
    try {
        const resp = await fetch(`/api/uploads/pdfs/${filename}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        await handleResponse(resp);
        loadPdfs();
    } catch (error) {
        // Error already handled by handleResponse
    }
}

async function deletePortfolioLink(id) {
    if (!confirm('Tem certeza que deseja excluir este link?')) return;
    
    try {
        const resp = await fetch(`/api/portfolio/links/${id}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        await handleResponse(resp);
        loadPortfolio();
    } catch (error) {
        // Error already handled by handleResponse
    }
}

async function togglePortfolioLink(id, isActive) {
    try {
        const resp = await fetch(`/api/portfolio/links/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ is_active: isActive })
        });
        await handleResponse(resp);
        loadPortfolio();
    } catch (error) {
        // Error already handled by handleResponse
    }
}

function editPortfolioLink(id) {
    const link = portfolioLinks.find(l => l.id === id);
    if (!link) return;
    
    document.getElementById('portfolio-title').value = link.title;
    document.getElementById('portfolio-url').value = link.url;
    document.getElementById('portfolio-description').value = link.description || '';
    document.getElementById('portfolio-pdf').value = link.pdf_url || '';
    
    // Change form to edit mode
    const form = document.getElementById('add-portfolio-form');
    form.dataset.editId = id;
    form.querySelector('button[type="submit"]').textContent = 'Atualizar link';
}

// Event Listeners
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    try {
        const resp = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ username, password })
        });
        await handleResponse(resp);
        loadPdfs();
        loadPortfolio();
    } catch (error) {
        // Error already handled by handleResponse
    }
});

document.getElementById('change-password-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const old_password = document.getElementById('old-password').value;
    const new_password = document.getElementById('new-password').value;
    try {
        const resp = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ old_password, new_password })
        });
        await handleResponse(resp);
        document.getElementById('change-password-form').reset();
    } catch (error) {
        // Error already handled by handleResponse
    }
});

document.getElementById('upload-pdf-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const file = document.getElementById('pdf-file').files[0];
    if (!file) {
        showMessage('Selecione um arquivo PDF', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf_file', file);
    
    try {
        const resp = await fetch('/api/upload/pdf', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });
        await handleResponse(resp);
        document.getElementById('upload-pdf-form').reset();
        loadPdfs();
    } catch (error) {
        // Error already handled by handleResponse
    }
});

document.getElementById('add-portfolio-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('portfolio-title').value;
    const url = document.getElementById('portfolio-url').value;
    const description = document.getElementById('portfolio-description').value;
    const pdf_url = document.getElementById('portfolio-pdf').value;
    
    const body = { title, url };
    if (description) body.description = description;
    if (pdf_url) body.pdf_url = pdf_url;
    
    const editId = e.target.dataset.editId;
    
    try {
        let resp;
        if (editId) {
            // Edit mode
            resp = await fetch(`/api/portfolio/links/${editId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(body)
            });
        } else {
            // Add mode
            resp = await fetch('/api/portfolio/links', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(body)
            });
        }
        
        await handleResponse(resp);
        document.getElementById('add-portfolio-form').reset();
        delete e.target.dataset.editId;
        e.target.querySelector('button[type="submit"]').textContent = 'Adicionar link';
        loadPortfolio();
    } catch (error) {
        // Error already handled by handleResponse
    }
});

// Load data on page load
window.addEventListener('load', () => {
    loadPdfs();
    loadPortfolio();
});
</script>

</body>
</html>

